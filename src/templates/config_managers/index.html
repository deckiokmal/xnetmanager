{% extends "/layouts/layout_table.html" %}
{% block page_heading %}Push Configuration & Backups{% endblock %}
{% block title %}Push Configurations{% endblock %}

{% block button_group1 %}
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<button id="checkStatusButton" type="button" class="btn btn-sm btn-info">Check status</button>
{% endblock %}

{% block button_group2 %}
<button id="pushConfigBtn" type="button" class="btn btn-sm btn-success">Push configs</button>
{% endblock %}

{% block button_group3 %}
<button type="button" class="btn btn-sm btn-danger" id="backupMultipleBtn">Backup configs</button>
{% endblock %}

{% block table_name %}Daftar Perangkat{% endblock %}

{% block form_filter_row %}
<form id="perPageForm" action="{{ url_for('network_configurator_bp.index') }}" method="get">
    <label class="d-flex align-items-center">
        <span>Tampilkan</span>
        <select id="itemsPerPage" name="per_page" class="form-select form-select-sm mx-2"
            onchange="document.getElementById('perPageForm').submit()">
            <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
            <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
        </select>
        <span>entri</span>
    </label>
    <input type="hidden" name="search" value="{{ search_query }}">
</form>
{% endblock %}

{% block form_search %}
<form id="searchForm" method="get" action="{{ url_for('network_configurator_bp.index') }}" class="form-inline d-flex">
    <input id="searchInput" type="text" name="search" class="form-control form-control-sm mr-2" placeholder="Search..."
        value="{{ search_query }}">
    <button class="btn btn-outline-success btn-sm" type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
    <input type="hidden" name="per_page" value="{{ per_page }}">
</form>
{% endblock %}

{% block table_header %}
<th scope="col">
    <button id="selectDevicesBtn" type="button" class="btn btn-primary btn-sm ml-3">Select</button>
</th>
<th>No</th>
<th onclick="sortTable(0)">Nama Perangkat <i class="fas fa-sort"></i></th>
<th onclick="sortTable(1)">Alamat IP <i class="fas fa-sort"></i></th>
<th onclick="sortTable(2)">Vendor <i class="fas fa-sort"></i></th>
<th>Status</th>
<th>Aksi</th>
{% endblock %}

{% block table_body %}
{% for device in devices %}
<tr>
    <th>
        <div class="container">
            <div id="checklistButtons{{ loop.index }}" class="checklist-buttons" style="display: none;">
                <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                    <input type="checkbox" class="btn-check checklist-buttons" id="btncheck{{ loop.index }}"
                        data-ip="{{ device.ip_address }}" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btncheck{{ loop.index }}">Select</label>
                </div>
            </div>
        </div>
    </th>
    <th scope="row">{{ loop.index + (page-1) * per_page }}</th>
    <td>{{ device.device_name }}</td>
    <td>{{ device.ip_address }}</td>
    <td>{{ device.vendor }}</td>
    <td>
        <div id="statusIndicator{{ device.id }}" class="status-indicator"></div>
    </td>
    <td>
        <button class="btn btn-sm btn-primary mb-1" data-bs-toggle="modal"
            data-bs-target="#pushConfigModal{{ device.id }}">Config</button>
        <button class="btn btn-sm btn-danger mb-1" data-bs-toggle="modal"
            data-bs-target="#backupModal{{ device.id }}">Backup</button>
    </td>
</tr>
{% endfor %}
{% endblock %}

{% block show_total_data %}
<div class="dataTables_info" id="dataTable_info" role="status" aria-live="polite">
    Menampilkan {{ (page - 1) * per_page + 1 }} hingga {{ (page - 1) * per_page + per_page if (page - 1) * per_page +
    per_page < total_devices else total_devices }} dari {{ total_devices }} entri </div>
        {% endblock %}

        {% block pagination %}
        {{ pagination.links }}
        {% endblock %}

        {% block modal_data %}
        <!-- Modals for Push Config, Backup, and Error Handling -->
        <!-- Modal untuk memilih File Konfigurasi (Push Config Multiple Devices) -->
        <div class="modal fade" id="selectConfigModal" tabindex="-1" aria-labelledby="selectConfigModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="selectConfigModalLabel">Select File for Push Config</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="configSelectionForm">
                            <div class="mb-3">
                                <label for="configSelect" class="form-label">Pilih file konfigurasi</label>
                                <select id="configSelect" class="form-select" required>
                                    <option value="" selected disabled>Select a config</option>
                                    {% for config in config_file %}
                                    <option value="{{ config.id }}">{{ config.config_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" id="confirmPushConfigBtn">Push Config</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal untuk menampilkan hasil push config -->
        <div class="modal fade" id="pushConfigResultModal" tabindex="-1" aria-labelledby="pushConfigResultModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-black text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pushConfigResultModalLabel">Push Config Results</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="pushConfigResultTable">
                            <!-- Tabel hasil push config akan dimuat di sini -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal untuk Push Config Single Device -->
        {% for device in devices %}
        <div class="modal fade" id="pushConfigModal{{ device.id }}" tabindex="-1"
            aria-labelledby="pushConfigModalLabel{{ device.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pushConfigModalLabel{{ device.id }}">Push Config for {{
                            device.device_name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="pushConfigForm{{ device.id }}">
                            <!-- Select Config -->
                            <div class="mb-3">
                                <label for="configSelect{{ device.id }}" class="form-label">Select Config</label>
                                <select class="form-select" id="configSelect{{ device.id }}" required>
                                    <option value="" disabled selected>Select a config</option>
                                    {% for config in config_file %}
                                    <option value="{{ config.id }}">{{ config.config_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Push Config</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <!-- Modal untuk Backup Multiple Devices -->
        <div class="modal fade" id="createBackupModal" tabindex="-1" aria-labelledby="createBackupModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createBackupModalLabel">Create Backup for Multiple Devices</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createBackupForm">
                            <!-- Backup Name Input -->
                            <div class="mb-3">
                                <label for="backupName" class="form-label">Backup Name</label>
                                <input type="text" class="form-control" id="backupName" name="backup_name" required>
                            </div>
                            <!-- Backup Description -->
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description"></textarea>
                            </div>
                            <!-- Backup Type Selection -->
                            <div class="mb-3">
                                <label for="backupType" class="form-label">Backup Type</label>
                                <select class="form-select" id="backupType" name="backup_type" required>
                                    <option value="full">Full Backup</option>
                                    <option value="incremental">Incremental Backup</option>
                                    <option value="differential">Differential Backup</option>
                                </select>
                            </div>
                            <!-- Retention Days -->
                            <div class="mb-3">
                                <label for="retentionDays" class="form-label">Retention Days</label>
                                <input type="number" class="form-control" id="retentionDays" name="retention_days">
                            </div>
                            <!-- Backup Command -->
                            <div class="mb-3">
                                <label for="command" class="form-label">Backup Command</label>
                                <select class="form-select" id="command" name="command" required>
                                    <option value="show running-config">Cisco</option>
                                    <option value="export compact terse">MikroTik</option>
                                    <option value="show full-configuration">Fortinet</option>
                                </select>
                            </div>
                            <!-- Hidden field to store selected devices -->
                            <input type="hidden" id="selectedBackupDevices" name="devices">
                            <button type="submit" class="btn btn-primary">Create Backup</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal untuk menampilkan hasil backup -->
        <div class="modal fade" id="backupResultModal" tabindex="-1" aria-labelledby="backupResultModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-black text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="backupResultModalLabel">Backup Results</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="backupResultTable">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal untuk Backup Single Device -->
        {% for device in devices %}
        <div class="modal fade" id="backupModal{{ device.id }}" tabindex="-1"
            aria-labelledby="backupModalLabel{{ device.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="backupModalLabel{{ device.id }}">Create Backup for {{
                            device.device_name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="backupForm{{ device.id }}">
                            <!-- Backup Name Input -->
                            <div class="mb-3">
                                <label for="backupName{{ device.id }}" class="form-label">Backup Name</label>
                                <input type="text" class="form-control" id="backupName{{ device.id }}"
                                    name="backup_name" required>
                            </div>
                            <!-- Backup Description -->
                            <div class="mb-3">
                                <label for="description{{ device.id }}" class="form-label">Description</label>
                                <textarea class="form-control" id="description{{ device.id }}"
                                    name="description"></textarea>
                            </div>
                            <!-- Backup Type -->
                            <div class="mb-3">
                                <label for="backupType{{ device.id }}" class="form-label">Backup Type</label>
                                <select class="form-select" id="backupType{{ device.id }}" name="backup_type" required>
                                    <option value="full">Full Backup</option>
                                    <option value="incremental">Incremental Backup</option>
                                    <option value="differential">Differential Backup</option>
                                </select>
                            </div>
                            <!-- Backup Command -->
                            <div class="mb-3">
                                <label for="command{{ device.id }}" class="form-label">Backup Command</label>
                                <select class="form-select" id="command{{ device.id }}" name="command" required>
                                    <option value="show running-config">Cisco</option>
                                    <option value="export compact terse">MikroTik</option>
                                    <option value="show full-configuration">Fortinet</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Create Backup</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <!-- Modal untuk menampilkan error -->
        <div class="modal fade" id="pushConfigErrorModal" tabindex="-1" aria-labelledby="pushConfigErrorModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-danger text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pushConfigErrorModalLabel">Configuration Error</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="pushConfigErrorModalBody">
                        <!-- Pesan error akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </div>
        {% endblock %}

        {% block script_js %}
        <script src="{{ url_for('static', filename='js/network_configurator.js') }}"></script>
        {% endblock %}