{% extends "/layouts/layout_table.html" %}
{% block title %}Backup Management{% endblock %}

{% block table_name %}Daftar File Backup{% endblock %}

<!-- Filter row page peritem 10, 25 dan 50 item per table -->
{% block form_filter_row %}
<form id="perPageForm" action="{{ url_for('backup.index') }}" method="get">
    <label class="d-flex align-items-center">
        <span>Tampilkan</span>
        <select name="per_page" class="form-select form-select-sm mx-2"
            onchange="document.getElementById('perPageForm').submit()">
            <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
            <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
        </select>
        <span>entri</span>
    </label>
    <input type="hidden" name="search" value="{{ search_query }}">
</form>
{% endblock %}

<!-- Search function -->
{% block form_search %}
<form id="searchForm" method="get" action="{{ url_for('backup.index') }}" class="form-inline d-flex">
    <input id="searchInput" type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search..."
        value="{{ search_query }}">
    <button class="btn btn-outline-success btn-sm" type="submit">
        <i class="fas fa-search"></i>
    </button>
    <input type="hidden" name="per_page" value="{{ per_page }}">
</form>
{% endblock %}

{% block table_header %}
<th>No</th>
<th>Nama Backup</th>
<th>Nama Device</th>
<th>Backup Type</th>
<th>Versi</th>
<th>Tanggal Dibuat</th>
<th>Jenis</th>
<th>Aksi</th>
{% endblock %}

{% block table_body %}
{% for backup in backups %}
<tr>
    <th scope="row">{{ loop.index + (page - 1) * per_page }}</th>
    <td>{{ backup.backup_name }}</td>
    <td>{{ backup.device.device_name }}</td>
    <td>{{ backup.backup_type }}</td>
    <td>{{ backup.version }}</td>
    <td>{{ backup.created_at.strftime('%Y-%m-%d') }}</td>
    <td>
        {% if backup.user_id == current_user.id %}
        <span class="badge bg-success">Milik Saya</span>
        {% else %}
        <span class="badge bg-info">Dibagikan ke Saya</span>
        {% endif %}
    </td>
    <td>
        <!-- Tombol untuk Detail Backup -->
        <button class="btn btn-info btn-sm" data-backup-id="{{ backup.id }}" onclick="showBackupDetails(this)">
            <i class="fas fa-eye"></i>
        </button>

        <!-- Jika pengguna adalah Admin atau Pemilik, tampilkan semua tombol tambahan -->
        {% if current_user.has_role('Admin') or backup.user_id == current_user.id %}

        <!-- Tombol untuk Update Backup -->
        <a href="{{ url_for('backup.update_backup', backup_id=backup.id) }}" class="btn btn-success btn-sm">
            <i class="fas fa-edit"></i>
        </a>

        <!-- Tombol untuk Hapus Backup -->
        <button class="btn btn-danger btn-sm" onclick="deleteBackup('{{ backup.id }}')">
            <i class="fas fa-trash"></i>
        </button>

        <!-- Tombol untuk Rollback Configuration -->
        <button class="btn btn-warning btn-sm" data-backup-id="{{ backup.id }}" onclick="initiateRollback(this)">
            <i class="fas fa-undo-alt"></i> Rollback
        </button>

        <!-- Tombol untuk Share Backup -->
        <button class="btn btn-info btn-sm" data-backup-id="{{ backup.id }}" onclick="openShareBackupModal(this)">
            <i class="fas fa-share-alt"></i> Share
        </button>
        {% endif %}
    </td>
</tr>
{% endfor %}
{% endblock %}

<!-- Show total data yang ditampilkan dan pagination -->
{% block show_total_data %}
<div class="dataTables_info" id="dataTable_info" role="status" aria-live="polite">
    Menampilkan {{ (page - 1) * per_page + 1 }} hingga {{ (page - 1) * per_page + per_page if
    (page - 1)
    * per_page + per_page < total_backups else total_backups }} dari {{ total_backups }} entri </div>
</div>
{% endblock %}

{% block pagination %}
<div class="col-12 col-md-7 d-flex justify-content-md-end pagination-sm">
    <!-- Link Pagination -->
    {{ pagination.links }}
</div>
{% endblock %}

{% block modal_data %}
<!-- Modal Detail Backup -->
<div class="modal fade" id="backupDetailModal" tabindex="-1" aria-labelledby="backupDetailModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupDetailModalLabel">Backup Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Nama Backup:</strong> <span id="detailBackupName"></span></p>
                <p><strong>Description:</strong> <span id="detailBackupDescription"></span></p>
                <p><strong>Versi:</strong> <span id="detailBackupVersion"></span></p>
                <p><strong>Tanggal Dibuat:</strong> <span id="detailBackupDate"></span></p>
                <p><strong>Encrypted:</strong> <span id="detailBackupEncrypted"></span></p>
                <p><strong>Compressed:</strong> <span id="detailBackupCompressed"></span></p>
                <p><strong>Integrity Check:</strong> <span id="detailBackupIntegrity"></span></p>
                <p><strong>Tags:</strong> <span id="detailBackupTags"></span></p>
                <p><strong>Konten Backup:</strong></p>
                <!-- Menambahkan Bootstrap class untuk tampilan konten dengan ukuran kecil -->
                <pre><code id="detailBackupContent" class="text-white bg-dark p-2 small" style="font-size: 0.75rem;"></code></pre>
            </div>
        </div>
    </div>
</div>

<!-- Modal Rollback Konfiguration -->
<div class="modal fade" id="rollbackConfirmModal" tabindex="-1" aria-labelledby="rollbackConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rollbackConfirmModalLabel">Confirm Rollback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to rollback to this backup version?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmRollbackBtn">Rollback</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Share Backup -->
<div class="modal fade" id="shareBackupModal" tabindex="-1" aria-labelledby="shareBackupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareBackupModalLabel">Share Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shareBackupForm">
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">User Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="permissionLevel" class="form-label">Permission Level</label>
                        <select class="form-select" id="permissionLevel">
                            <option value="read-only">Read-Only</option>
                            <option value="edit">Edit</option>
                            <option value="transfer">Transfer Ownership</option>
                        </select>
                    </div>
                    <input type="hidden" id="backupId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="shareBackupBtn">Share</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script_js %}
<!-- JavaScript handle search input -->
<script>
    let timeout = null;

    document.getElementById("searchInput").addEventListener("input", function () {
        clearTimeout(timeout);

        timeout = setTimeout(function () {
            document.getElementById('searchForm').submit();
        }, 1000);
    });

    document.getElementById("searchInput").addEventListener("input", function () {
        const query = this.value.toLowerCase();
        const rows = document.querySelectorAll("#dataTable tbody tr");

        rows.forEach(row => {
            const backup_name = row.cells[1].textContent.toLowerCase();
            const device_name = row.cells[2].textContent.toLowerCase();
            const backup_type = row.cells[3].textContent.toLowerCase();

            if (backup_name.includes(query) || device_name.includes(query) || backup_type.includes(query)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });
</script>

<!-- JavaScript to Fetch Backup Details and Populate Modal -->
<script>
    function showBackupDetails(button) {
        const backupId = button.getAttribute("data-backup-id");

        fetch(`/detail-backup/${backupId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('detailBackupName').textContent = data.backup_name;
                    document.getElementById('detailBackupDescription').textContent = data.description;
                    document.getElementById('detailBackupVersion').textContent = data.version;
                    document.getElementById('detailBackupDate').textContent = new Date(data.created_at).toLocaleString();
                    document.getElementById('detailBackupEncrypted').textContent = data.is_encrypted ? "Yes" : "No";
                    document.getElementById('detailBackupCompressed').textContent = data.is_compressed ? "Yes" : "No";
                    document.getElementById('detailBackupIntegrity').textContent = data.integrity_check || "N/A";
                    document.getElementById('detailBackupTags').textContent = data.tags.join(', ') || "None";

                    if (data.file_content) {
                        document.getElementById('detailBackupContent').textContent = data.file_content;
                    } else {
                        document.getElementById('detailBackupContent').textContent = "No content available.";
                    }

                    var detailModal = new bootstrap.Modal(document.getElementById("backupDetailModal"));
                    detailModal.show();
                }
            })
            .catch(error => console.error('Error fetching backup details:', error));
    }
</script>

<!-- JavaScript handle rollback configuration -->
<script>
    function initiateRollback(button) {
        const backupId = button.getAttribute("data-backup-id");
        document.getElementById("confirmRollbackBtn").setAttribute("data-backup-id", backupId);

        var rollbackModal = new bootstrap.Modal(document.getElementById("rollbackConfirmModal"));
        rollbackModal.show();
    }

    document.getElementById("confirmRollbackBtn").addEventListener("click", function () {
        const backupId = this.getAttribute("data-backup-id");

        fetch(`/rollback-backup/${backupId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                var rollbackModal = bootstrap.Modal.getInstance(document.getElementById("rollbackConfirmModal"));
                rollbackModal.hide();
            })
            .catch(error => console.error('Error during rollback:', error));
    });
</script>

<!-- JavaScript handle share backup -->
<script>
    // Fungsi untuk membuka modal Share Backup dan mengisi hidden input dengan backupId
    function openShareBackupModal(button) {
        const backupId = button.getAttribute("data-backup-id");
        document.getElementById("backupId").value = backupId;

        const shareModal = new bootstrap.Modal(document.getElementById("shareBackupModal"));
        shareModal.show();
    }

    // Event listener untuk tombol 'Share' dalam modal
    document.getElementById('shareBackupBtn').addEventListener('click', function () {
        const userEmail = document.getElementById('userEmail').value;
        const permissionLevel = document.getElementById('permissionLevel').value;
        const backupId = document.getElementById('backupId').value;

        // Validasi input email dan backupId
        if (!userEmail || !backupId) {
            alert('Please provide a valid email and backup ID');
            return;
        }

        // Kirim request POST untuk berbagi backup
        fetch("/share-backup", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                user_email: userEmail,
                backup_id: backupId,
                permission_level: permissionLevel
            })
        })
            .then(response => {
                // Tambahkan log untuk memeriksa status HTTP dari backend
                console.log(`Response Status: ${response.status}`);

                // Ambil JSON dari respons
                return response.json().then(data => {
                    // Cek apakah respons sukses
                    if (response.ok) {
                        alert(data.message);  // Tampilkan pesan sukses dari server
                        const modal = bootstrap.Modal.getInstance(document.getElementById('shareBackupModal'));
                        modal.hide();  // Tutup modal setelah berhasil
                        location.reload();  // Reload halaman untuk memperbarui data
                    } else {
                        // Tambahkan log untuk pesan error dari server
                        console.error(`Error Message: ${data.message}`);
                        alert(data.message || 'Error sharing backup');
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sharing backup');
            });
    });
</script>
{% endblock %}